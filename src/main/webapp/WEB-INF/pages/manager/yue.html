<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>约</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="stylesheet" href="${request.contextPath}/css/iteminfo.css">
    <style type="text/css">
        body{font-family: Arial, Helvetica, sans-serif;}
        .infinite-scroll-preloader {
            margin-top:-20px;
        }
        .commentAvatarDiv{
            width: 50px;
            height: 50px;
            padding:0px;
            background: #ececec;
            border-radius:50px;
            box-shadow: 0px 0px 0px rgba(0,0,0,0.4);
            -moz-border-radius: 50px;
            -webkit-border-radius: 50px;
        }
        .commentAvatarImage{
            width:50px;
            height:50px;
            line-height: 0;	 /* remove line-height */
            display: inline-block;	/* circle wraps image */
            border-radius: 50%;	/* relative value */
            -moz-border-radius: 50%;
            -webkit-border-radius: 50%;
            transition: linear 0.25s;
        }
    </style>
</head>
<body>
<!-- page集合的容器，里面放多个平行的.page，其他.page作为内联页面由路由控制展示 -->
<div class="page-group">
    <!-- 单个page ,第一个.page默认被展示-->
    <div class="page">
        <!-- 标题栏 -->
        <header class="bar bar-nav">
            <a class="icon icon-menu pull-left open-panel"></a>
            <h1 class="title">约管理</h1>
        </header>

        <!-- 这里是页面内容区 -->
        <div class="content">
            <div class="buttons-tab">
                <a href="#applyTab" class="tab-link active button">待审批</a>
                <a href="#saleTab" class="tab-link button">销售中</a>
                <a href="#undercarriageTab" class="tab-link button">已下架</a>
                <a href="#notpassTab" class="tab-link button">审核未通过</a>
            </div>

            <div class="tabs">
                <div id="applyTab" class="tab active infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
                <div id="saleTab" class="tab infinite-scroll">
                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
                <div id="undercarriageTab" class="tab infinite-scroll">
                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
                <div id="notpassTab" class="tab infinite-scroll">
                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>
<!-- popup, panel 等放在这里 -->
<div class="panel-overlay"></div>
<!-- Left Panel with Reveal effect -->
<div class="panel panel-left panel-reveal">
    <div class="content-block">
        <p>菜单</p>
        <div class="list-block">
            <ul style="background: #1c1d1f;">
                <a href="${request.contextPath}/manager/item/to-yue-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">约管理</div>
                        </div>
                    </li>
                </a>
                <a href="${request.contextPath}/manager/bid/to-bid-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">飚管理</div>
                        </div>
                    </li>
                </a>
                <a href="${request.contextPath}/manager/user/to-user-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">用户管理</div>
                        </div>
                    </li>
                 </a>
                <a href="${request.contextPath}/manager/crowdFunding/toCrowdFundingManager" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">众筹管理</div>
                        </div>
                    </li>
                </a>
                <a href="${request.contextPath}/manager/withdrawalLog/gotoWithdrawalLog" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">提现管理</div>
                        </div>
                    </li>
                </a>
            </ul>
        </div>
    </div>
</div>
<div class="popup" style="background: #eee;">
    <div class="content-block yl-content">
        <header class="bar bar-nav">
            <a class="icon icon-left pull-left back"></a>
            <h1 class="title">预览</h1>
        </header>
        <div class="yl-panel">
            <div class="row">
                <div class="col-100"><h2 style="color: #000;"><span id="titleSp"></span></h2></div>
            </div>
            <div class="row direct-telephone-con" >
                <div class="jz-yl-contac jz-yl-list2" id="itemTypeSp"></div>
                <div class="col-50 jz-yl-list2 jz-list-toggle1"><span id="priceSp"></span>元/<span id="durationSp" ></span>分钟</div>
            </div>

        </div>
        <div class="content-padded">
            <input type="hidden" id="itemId">
            <h5 class="m-title-bg-icon">项目实践时间</h5>
            <div id="practiceTimeDiv" class="pos-r-b"></div>
            <h5>项目对象所在行业、层级和特征</h5>
            <div id="itemToObjectDiv"></div>
            <h5>项目描述或特色</h5>
            <div id="descriptionDiv"></div>
            <h5>项目创造的价值</h5>
            <div id="itemValueDiv"></div>
            <h5>直约分享内容描述</h5>
            <div id="practiceDescriptionDiv"></div>
            <h5>分类</h5>
            <div id="itemCatalogDiv" class="un-border" style="display:none;"></div>
            <div class="un-border jz-add-data">
            </div>
        </div>

    </div>
    <div class="list-block cards-list" style="margin-top: 0">
        <ul>
            <li class="card item-list-title box-shadow-bottom">
                <div class="card-header">不通过原因</div>
                <div class="card-content">
                    <div class="card-content-inner">
                        <div class="item-input">
                            <textarea id="notPassReason" style="width: 100%" placeholder="请输入不通过原因"></textarea>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div class="content-block new-main-btn" id="btnDiv">
        <div class="row">
            <div class="col-50"><a href="#" class="button button-big button-fill button-danger" id="applyBtn">通过</a></div>
            <div class="col-50"><a href="#" class="button button-big button-fill button-success" id="notpassBtn">不通过</a></div>
        </div>
    </div>
</div>
<!-- 默认必须要执行$.init(),实际业务里一般不会在HTML文档里执行，通常是在业务页面代码的最后执行 -->
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>

<script>
    $.showIndicator();
    var loading = false;
    // 每次加载添加多少条目
    var itemsPerLoad = 10;
    // 最多可加载的条目
    var maxItems = 30;

    function addItems(number, lastIndex,data,tabId) {
        // 生成新条目的HTML
        var html = '';
        var dataLength = 0;
        $.each(data, function(i, item){
            var headPic = item.headImgPath;
            if(headPic == '' || headPic == null){
                headPic = '${request.contextPath}/images/default_head.jpg';
            }

            html += '<ul id="'+item.item.itemId+'">'+
                    '<li>'+
                    '<a href="#" class="item-link item-content" onclick="toViewUserItem(\''+item.item.itemId+'\',\''+item.item.itemStatus+'\',\''+item.item.recommend+'\')">'+
                    '<div class="item-media">' +
                    '<div class="commentAvatarDiv">' +
                    '<img class="commentAvatarImage" src="'+headPic+'" />' +
                    '</div>' +
                    '</div>'+
                    '<div class="item-inner">'+
                    '<div class="item-title-row">'+
                    '<div class="item-title">'+item.item.title+'</div>'+
                    '</div>'+
                    '<div class="item-subtitle">'+item.item.createUserName+'</div>'+
                    '<div class="item-text">'+item.item.price+'元</div>'+
                    '</div>'+
                    '</a>'+
                    '</li>'+
                    '</ul>';
            dataLength += 1;
        });
        if(dataLength == 0){
            $('.no-record').show();
            $('.infinite-scroll-preloader').remove();
        }else{
            $('.no-record').hide();
            $('.infinite-scroll-preloader').hide();
            // 添加新条目
            $('#'+tabId+'.infinite-scroll .list-block').append(html);
        }
        $.hideIndicator();
    }
    $(document).on("pageInit", function() {
        var searchHeight = $('.bar-header-secondary').css('height');
        $('.content').css('top',searchHeight);
        $.showIndicator();

        var  lastIndex = $('.list-block ul').length;
        loadFirst('apply_for_online','applyTab');
        loadFirst('for_sale','saleTab');
        loadFirst('not_pass','notpassTab');
        loadFirst('undercarriage','undercarriageTab');

        $(document).on('infinite', function() {
            // 如果正在加载，则退出
            if (loading) return;
            // 设置flag
            loading = true;
            var tabIndex = 0;
            var dataType = 'apply_for_online';
            var tabId = $(this).find('.infinite-scroll.active').attr('id');
            if(tabId == "saleTab"){
                tabIndex = 1;
                dataType = 'for_sale';
            }
            if(tabId == "notpassTab"){
                tabIndex = 3;
                dataType = 'not_pass';
            }
            if(tabId == "undercarriageTab"){
                tabIndex = 2;
                dataType = 'undercarriage';
            }
            lastIndex = $('.list-block').eq(tabIndex).find('ul').length;
            $.post('${request.contextPath}/manager/item/list', {itemStatus:dataType,startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                setTimeout(function() {
                    // 重置加载flag
                    loading = false;

                    if (lastIndex >= maxItems) {
                        // 加载完毕，则注销无限加载事件，以防不必要的加载
                        $.detachInfiniteScroll($('.infinite-scroll'));
                        // 删除加载提示符
                        $('.infinite-scroll-preloader').remove();
                        return;
                    }
                    // 添加新条目
                    addItems(itemsPerLoad, lastIndex,response,tabId);
                    // 更新最后加载的序号
                    lastIndex = $('.list-block ul').length;
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                }, 1000);
            });
        });
    });
    var loadFirst = function(itemStatus,tabId){
        $.post('${request.contextPath}/manager/item/list', {itemStatus:itemStatus,startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            $('#'+tabId+'.infinite-scroll .list-block').empty();
            //预先加载20条
            addItems(itemsPerLoad, 0,response,tabId);
            $.hideIndicator();
        });
    }
    function toViewUserItem(id,itemStatus,recommend){

        var btnApply = {text: '审批',bold: true,color: 'danger',onClick: function() {
            findItemById(id,'apply');
            $.popup('.popup');
        }
        };
        var btnUndercarriage = {text: '下架',bold: true,color: 'danger',onClick: function() {
            toEdit(id,'undercarriage');
        }
        };
        var btnRecommend = {text: '推荐',bold: true,color: 'danger',onClick: function() {
            toEdit(id,'recommend');
        }
        };
        var btnUnrecommend = {text: '取消推荐',bold: true,color: 'danger',onClick: function() {
            toEdit(id,'unrecommend');
        }
        };
        var btnOnshelf = {text: '上架',bold: true,color: 'danger',onClick: function() {
            toEdit(id,'onshelf');
        }
        };
        var detailApply = {text: '详情',bold: true,color: 'danger',onClick: function() {
            findItemById(id,'view');
            $.popup('.popup');
        }
        };
        var buttons1;
        if(itemStatus == 'apply_for_online'){
            buttons1 = [btnApply,detailApply];
        }else if(itemStatus == 'for_sale'){
            if(recommend != 'true'){
                buttons1 = [btnUndercarriage,btnRecommend,detailApply];
            }else{
                buttons1 = [btnUndercarriage,btnUnrecommend,detailApply];
            }
        }else if(itemStatus == 'undercarriage'){
            buttons1 = [btnOnshelf,detailApply];
        }else{
            buttons1 = [detailApply];
        }
        var buttons2 = [{text: '取消',bg: 'danger'}];
        var groups = [buttons1, buttons2];
        $.actions(groups);
    }
    window.onpopstate = function(){
        $.closeModal();
    };
    function findItemById(itemId,opt){
        history.pushState(null, "预览", window.location.href+"#");
        if(opt == 'view'){
            $('#btnDiv').hide();
        }else{
            $('#btnDiv').show();
        }
        $.showIndicator();
        $.get('${request.contextPath}/manager/item/get-item', {itemId: itemId}, function (response) {
            if(response){
                $('#itemId').val(itemId);
                if(response.itemType == 'tel'){
                    $('#itemTypeSp').text('电话直连');
                }else if(response.itemType == 'meet'){
                    $('#itemTypeSp').text('直约面对面');
                }
                $('#titleSp').text(response.title);
                $('#priceSp').text(response.price);
                $('#durationSp').text(response.duration);
                $('#descriptionDiv').text(response.description);
                $('#practiceDescriptionDiv').text(response.practiceDescription);
                $('#practiceTimeDiv').text(response.practiceTime);
                $('#itemToObjectDiv').text(response.itemToObject);
                $('#itemValueDiv').text(response.itemValue);
                $('#itemCatalogDiv').text(response.itemCatalog);
                $('#useCountSp').text(response.useCount);
                if(response.itemStatus == 'not_pass'){
                    $('#notPassReason').text(response.notPassReason);
                }
                $.hideIndicator();
            }
        });
    }
    function removeRecord(id) {
        $('#'+id).remove();
    }
    $("body").on( "click", "#applyBtn", function(){
        var itemId = $('#itemId').val();
        $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'for_sale'}, function (response) {
            if(response){
                if(response != null && response != ''&& response != 'failed'){
                    $.toast('审批成功');
                    removeRecord(itemId);
                    setTimeout('$.router.back()',2000);
                }else{
                    $.toast('审批失败');
                }
            }

        });
    } );
    $("body").on( "click", "#notpassBtn", function() {
        var itemId = $('#itemId').val();
        $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'not_pass',notPassReason:$('#notPassReason').val()}, function (response) {
            if(response){
                if(response != null && response != ''&& response != 'failed'){
                    $.toast('审批成功');
                    removeRecord(itemId);
                    setTimeout('$.router.back()',2000);
                }else{
                    $.toast('审批失败');
                }
            }

        });
    });
    var toEdit = function (itemId,opt){
        if(opt == 'undercarriage'){
            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'undercarriage'}, function (response) {

                if(response){
                    if(response != null && response != ''&& response != 'failed'){
                        $.alert('下架成功');
                        removeRecord(itemId);
                    }else{
                        $.alert('审批失败');
                    }
                }
            });
        }else if(opt == 'delete'){
            if(confirm("你是否要删除？")){

            }
        }else if(opt == 'recommend'){

            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'for_sale',recommend:'true'}, function (response) {
                if(response){
                    if(response != 'failed'){
                        $.alert('推荐成功');
                    }else{
                        $.alert('推荐失败');
                    }
                }
            });

        }else if(opt == 'unrecommend'){

                $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,recommend:'false'}, function (response) {

                    if(response){
                        if(response != 'failed'){
                            $.alert('操作成功');
                        }else{
                            $.alert('操作失败');
                        }
                    }

                });
        }else if(opt == 'onshelf'){
            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'for_sale'}, function (response) {

                if(response){
                    if(response != null && response != ''&& response != 'failed'){
                        $.alert('上架成功');
                        removeRecord(itemId);
                    }else{
                        $.alert('上架失败');
                    }
                }
            });
        }

    }
</script>
<script>$.init()</script>
</body>