<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>约</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="stylesheet" href="${request.contextPath}/css/iteminfo.css">
    <style type="text/css">
        body{font-family: Arial, Helvetica, sans-serif;}
        .infinite-scroll-preloader {
            margin-top:-20px;
        }
    </style>
</head>
<body>
<!-- page集合的容器，里面放多个平行的.page，其他.page作为内联页面由路由控制展示 -->
<div class="page-group">
    <!-- 单个page ,第一个.page默认被展示-->
    <div class="page">
        <!-- 标题栏 -->
        <header class="bar bar-nav">
            <a class="icon icon-menu pull-left open-panel"></a>
            <h1 class="title">飚管理</h1>
        </header>

        <!-- 这里是页面内容区 -->
        <div class="content">
            <div class="buttons-tab">
                <a href="#ongoingTab" class="tab-link active button">进行中</a>
                <a href="#finishTab" class="tab-link button">已完成</a>
                <a href="#stoppedTab" class="tab-link button">已终止</a>
            </div>

            <div class="tabs">
                <div id="ongoingTab" class="tab active infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
                <div id="finishTab" class="tab infinite-scroll">
                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
                <div id="stoppedTab" class="tab infinite-scroll">
                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>
<!-- popup, panel 等放在这里 -->
<div class="panel-overlay"></div>
<!-- Left Panel with Reveal effect -->
<div class="panel panel-left panel-reveal">
    <div class="content-block">
        <p>菜单</p>
        <div class="list-block">
            <ul style="background: #1c1d1f;">
                <a href="${request.contextPath}/manager/item/to-yue-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">约管理</div>
                        </div>
                    </li>
                </a>
                <a href="${request.contextPath}/manager/bid/to-bid-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">飚管理</div>
                        </div>
                    </li>
                 </a>
                <a href="${request.contextPath}/manager/user/to-user-manage" data-no-cache="true" class="close-panel">
                    <li class="item-content item-link">
                        <div class="item-media"><i class="icon icon-f7"></i></div>
                        <div class="item-inner">
                            <div class="item-title">用户管理</div>
                        </div>
                    </li>
                 </a>
            </ul>
        </div>
    </div>
</div>
<div class="popup" style="background: #eee;">
    <div class="content-block yl-content">
        <header class="bar bar-nav">
            <a class="icon icon-left pull-left back"></a>
            <h1 class="title">查看</h1>
        </header>
        <div class="yl-panel">
            <div class="row">
                <div class="col-100"><h2 style="color: #000;"><span id="titleSp"></span></h2></div>
            </div>
        </div>
        <div class="content-padded">
            <input type="hidden" id="bidId">
            <h5 class="m-title-bg-icon">内容</h5>
            <div id="contentDiv" ></div>
        </div>

    </div>
    <div class="list-block cards-list" style="margin-top: 0">
        <ul>
            <li class="card item-list-title box-shadow-bottom">
                <div class="card-header">终止原因</div>
                <div class="card-content">
                    <div class="card-content-inner">
                        <div class="item-input">
                            <textarea id="stopReason" style="width: 100%" placeholder="请输入终止原因"></textarea>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div class="content-block new-main-btn" id="btnDiv">
        <div class="row">
            <div class="col-100"><a href="#" class="button button-big button-fill button-success" id="stopBtn">终止</a></div>
        </div>
    </div>
</div>
<!-- 默认必须要执行$.init(),实际业务里一般不会在HTML文档里执行，通常是在业务页面代码的最后执行 -->
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>

<script>
    $.showIndicator();
    var loading = false;
    // 每次加载添加多少条目
    var itemsPerLoad = 10;
    // 最多可加载的条目
    var maxItems = 30;

    function addItems(number, lastIndex,data,tabId) {
        // 生成新条目的HTML
        var html = '';
        var dataLength = 0;
        $.each(data, function(i, item){
            var endDate =  new Date(item.endTime.replace(/-/g,"/"));
            var endTimeStr = '';
            if(endDate.getTime() < new Date().getTime()){
                endTimeStr = '已过期';
            }else{
                endTimeStr = '截止日期：'+item.endTime;
            }
            html += '<ul id="'+item.bidId+'">'+
                    '<li>'+
                    '<a href="#" class="item-link item-content" onclick="toViewBid(\''+item.bidId+'\',\''+item.bidStatus+'\',\''+item.userId+'\')">'+
                    '<div class="item-inner">'+
                    '<div class="item-title-row">'+
                    '<div class="item-title">'+item.title+'</div>'+
                    '</div>'+
                    '<div class="item-subtitle">'+item.createUserName+'<span style="float: right">飚数：'+item.submitCount+'</span></div>'+
                    '<div class="item-text">'+item.price+'元<span style="float: right">'+endTimeStr+'</span></div>'+
                    '</div>'+
                    '</a>'+
                    '</li>'+
                    '</ul>';
            dataLength += 1;
        });
        if(dataLength == 0){
            $('.no-record').show();
            $('.infinite-scroll-preloader').remove();
        }else{
            $('.no-record').hide();
            $('.infinite-scroll-preloader').hide();
            // 添加新条目
            $('#'+tabId+'.infinite-scroll .list-block').append(html);
        }
        $.hideIndicator();
    }
    $(document).on("pageInit", function() {
        var searchHeight = $('.bar-header-secondary').css('height');
        $('.content').css('top',searchHeight);
        $.showIndicator();

        var  lastIndex = $('.list-block ul').length;
        loadFirst('ongoing','ongoingTab');
        loadFirst('finish','finishTab');
        loadFirst('stopped','stoppedTab');

        $(document).on('infinite', function() {
            // 如果正在加载，则退出
            if (loading) return;
            // 设置flag
            loading = true;
            var tabIndex = 0;
            var dataType = 'ongoing';
            var tabId = $(this).find('.infinite-scroll.active').attr('id');
            if(tabId == "finishTab"){
                tabIndex = 1;
                dataType = 'finish';
            }
            if(tabId == "stoppedTab"){
                tabIndex = 2;
                dataType = 'stopped';
            }
            lastIndex = $('.list-block').eq(tabIndex).find('ul').length;
            $.post('${request.contextPath}/manager/bid/list', {bidStatus:dataType,startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                setTimeout(function() {
                    // 重置加载flag
                    loading = false;

                    if (lastIndex >= maxItems) {
                        // 加载完毕，则注销无限加载事件，以防不必要的加载
                        $.detachInfiniteScroll($('.infinite-scroll'));
                        // 删除加载提示符
                        $('.infinite-scroll-preloader').remove();
                        return;
                    }
                    // 添加新条目
                    addItems(itemsPerLoad, lastIndex,response,tabId);
                    // 更新最后加载的序号
                    lastIndex = $('.list-block ul').length;
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                }, 1000);
            });
        });
    });
    var loadFirst = function(bidStatus,tabId){
        $.post('${request.contextPath}/manager/bid/list', {bidStatus:bidStatus,startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            $('#'+tabId+'.infinite-scroll .list-block').empty();
            //预先加载20条
            addItems(itemsPerLoad, 0,response,tabId);
            $.hideIndicator();
        });
    }
    function toViewBid(id,bidStatus,createUserId){

        var btnViewPhone = {text: '查看飚主电话',bold: true,color: 'danger',onClick: function() {
            $.showIndicator();
            $.post('${request.contextPath}/user/get-simple-userinfo', {userId:createUserId}, function (response) {
                $.alert(response.mobile);
                $.hideIndicator();
            });

        }
        };
        var btnDetail = {text: '飚详情',bold: true,color: 'danger',onClick: function() {
            findItemById(id,bidStatus);
            $.popup('.popup');
        }
        };
        var buttons1;
        if(bidStatus == 'ongoing'){
            buttons1 = [btnViewPhone,btnDetail];
        }else if(bidStatus == 'finish'){
            buttons1 = [btnViewPhone,btnDetail];
        }else if(bidStatus == 'stopped'){
            buttons1 = [btnViewPhone,btnDetail];
        }
        var buttons2 = [{text: '取消',bg: 'danger'}];
        var groups = [buttons1, buttons2];
        $.actions(groups);
    }
    window.onpopstate = function(){
        $.closeModal();
    };
    function findItemById(bidId,bidStatus){
        history.pushState(null, "预览", window.location.href+"#");
        if(bidStatus == 'stopped'){
            $('#btnDiv').hide();
        }else{
            $('#btnDiv').show();
        }
        $.showIndicator();
        $.get('${request.contextPath}/manager/bid/get-bid', {bidId: bidId}, function (response) {
            if(response){
                $('#bidId').val(bidId);

                $('#titleSp').text(response.title);
                $('#contentDiv').text(response.content);

                if(response.bidStatus == 'stopped'){
                    $('#stopReason').text(response.stopReason);
                }
                $.hideIndicator();
            }
        });
    }
    function removeRecord(id) {
        $('#'+id).remove();
    }

    $("body").on( "click", "#stopBtn", function() {
        var bidId = $('#bidId').val();
        $.get('${request.contextPath}/manager/bid/modify', {bidId: bidId,bidStatus: 'stopped',stopReason:$('#stopReason').val()}, function (response) {
            if(response){
                if(response != null && response != ''&& response != 'failed'){
                    $.toast('终止成功');
                    removeRecord(bidId);
                    setTimeout('$.router.back()',2000);
                }else{
                    $.toast('终止失败');
                }
            }

        });
    });
    var toEdit = function (itemId,opt){
        if(opt == 'undercarriage'){
            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'undercarriage'}, function (response) {

                if(response){
                    if(response != null && response != ''&& response != 'failed'){
                        $.alert('下架成功');
                        removeRecord(itemId);
                    }else{
                        $.alert('审批失败');
                    }
                }
            });
        }else if(opt == 'delete'){
            if(confirm("你是否要删除？")){

            }
        }else if(opt == 'recommend'){

            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'for_sale',recommend:'true'}, function (response) {
                if(response){
                    if(response != 'failed'){
                        $.alert('推荐成功');
                    }else{
                        $.alert('推荐失败');
                    }
                }
            });

        }else if(opt == 'unrecommend'){

                $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,recommend:'false'}, function (response) {

                    if(response){
                        if(response != 'failed'){
                            $.alert('操作成功');
                        }else{
                            $.alert('操作失败');
                        }
                    }

                });
        }else if(opt == 'onshelf'){
            $.get('${request.contextPath}/manager/item/modify', {itemId: itemId,itemStatus: 'for_sale'}, function (response) {

                if(response){
                    if(response != null && response != ''&& response != 'failed'){
                        $.alert('上架成功');
                        removeRecord(itemId);
                    }else{
                        $.alert('上架失败');
                    }
                }
            });
        }

    }
</script>
<script>$.init()</script>
</body>