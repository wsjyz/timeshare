<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>编辑众筹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="众筹">
    <meta name="Keywords" content="众筹">
    <meta name="Description" content="众筹">

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/css/crowdFunding/sm-extend.min.css">
    <link rel="stylesheet" href="${request.contextPath}/css/upload.css">
    <link rel="stylesheet" href="${request.contextPath}/css/crowdFunding/img-custom.css">
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/css/crowdFunding/style.css">
</head>
<body>
<div class="page-group">
    <div class="page page-current" id="page-crowdFundingEdit">
        <!--header start-->
        <header class="bar bar-nav">
            <a class="icon icon-left pull-left back" href="javascript:history.go(-1);"></a>
            <h1 class="title"></h1>
        </header>
        <!--header end-->
        <!--页面内容区域 start-->
        <div class="content">
            <section class="from-list">
                <form action="${request.contextPath}/crowdFunding/edit" method="post" id="editCrowdFunding">
                    <label class="form-group">
                        <span class="input-label">项目名称</span>
                        <input type="text" name="projectName" id="projectName" value="${crowdFunding.projectName}" class="form-control" placeholder="项目名称">
                    </label>
                    <label class="form-group">
                        <span class="input-label">课程开始时间</span>
                        <input type="text" name="curriculumStartTime" class="form-control" placeholder="课程开始时间" id="startTime">
                    </label>
                    <label class="form-group">
                        <span class="input-label">课程结束时间</span>
                        <input type="text" name="curriculumEndTime" class="form-control" placeholder="课程结束时间" id="endTime">
                    </label>
                    <label class="form-group">
                        <span class="input-label">主办地址</span>
                        <input type="text" name="sponsorCity" value="${crowdFunding.sponsorCity}" class="form-control" placeholder="主办地址" id="address" value="">
                    </label>
                    <label class="form-group">
                        <span class="input-label">详情描述</span>
                        <textarea rows="5" name="detail" id="detail" class="form-control" placeholder="详情描述">${crowdFunding.detail}</textarea>
                    </label>
                    <div class="radio-group">


                        <label><input type="radio" name="costType" value="AA" id="costBetween" <#if crowdFunding.costType=='AA'>checked</#if>>费用均摊</label>
                        <label><input type="radio" name="costType" value="FIXED_PRICE" id="price" <#if crowdFunding.costType=='FIXED_PRICE'>checked</#if>> 一口价</label>
                    </div>
                    <label class="form-group">
                        <#assign costTypeName="">
                        <#if crowdFunding.costType=="AA">
                            <#assign costTypeName="总费用">
                        <#else>
                            <#assign costTypeName="单价">
                        </#if>
                        <span class="input-label" id="costSpan">${costTypeName}</span>
                        <input type="number" name="costTotal" id="costTotal" value="${crowdFunding.costTotal}" class="form-control" placeholder="${costTypeName}">
                    </label>
                    <label class="form-group">
                        <span class="input-label">最少人数</span>
                        <input type="number" name="minPeoples" id="minPeoples" value="${crowdFunding.minPeoples}" class="form-control" placeholder="最少人数">
                    </label>
                    <label class="form-group">
                        <span class="input-label">最多人数</span>
                        <input type="number" name="maxPeoples" value="${crowdFunding.maxPeoples}" id="maxPeoples" class="form-control" placeholder="最多人数">
                    </label>
                    <label class="form-group">
                        <span class="input-label">预约费用</span>
                        <input type="number" name="reservationCost" id="reservationCost" value="${crowdFunding.reservationCost}" class="form-control" placeholder="预约费用">
                    </label>
                    <label class="form-group">
                        <span class="input-label">众筹封面</span>
                        <!--<input type="file" class="form-file">-->

                        <a class="subjectPicture" href="#crowdFundingAddWallpaper" onclick="updateType();">   <img src="${request.contextPath}/images/assembly/icon/publishImg.png" /></a>


                        <#assign editImgShowPath=""/>
                        <#if crowdFunding.imageUrl??>
                            <#assign editImgShowPath="${request.contextPath}/${crowdFunding.imageUrl}_320x240.jpg"/>
                        </#if>

                        <div class="imgShow" ><img src="${editImgShowPath}" id="crowdFundingImageUrl" style="height: 5rem;width: 10rem;"/></div>



                    </label>
                    <div class="content-block">
                        <div class="row">
                            <div class="col-33"><input type="button" id="sketch" class="button button-big btn-dark" value="保存草稿" onclick="sketchCrowdFundingClick();"></div>
                            <div class="col-33"><input type="button" id="publish" class="button button-big btn-dark" value="发 布" onclick="publishCrowdFundingClick()"></div>
                            <div class="col-33"><a href="javascript:preview();" class="button button-big btn-light open-popup" data-popup=".popup-preview">预 览</a></div>

                        </div>
                    </div>
                    <input type="hidden" name="crowdfundingStatus" id="crowdfundingStatus" value="RELEASED">
                    <input type="hidden" name="imgUrl" id="imgUrl" value="">
                    <input type="hidden" name="crowdfundingId" id="crowdfundingId" value="${crowdFunding.crowdfundingId}">
                </form>
            </section>
        </div>
        <!-- 页面内容区域 end -->
    </div>


    <!--图片上传-->
    <div class="page" id="crowdFundingAddWallpaper">
        <div class="activityPublishHeader header">
            <h1 class="title">添加众筹封面</h1>
            <a class="button button-link button-nav back pull-left">
                <span class="icon icon-left"></span>
                返回
            </a>
            <a class="button button-link button-nav back pull-right publish" id="editImgFinish">
                完成
            </a>

        </div>
        <div class="content activityPublishContent">
            <div class="list-block">
                <input type="hidden" id="imageId" value=""/>
                <img src="" id="imageUrl" style="display: none;margin: 0 auto;height: 9rem;width: 16rem;"/>
                <div class="main-wrap">
                    <div id="uploader">
                        <div class="queueList fix">
                            <div class="filelist"></div>
                            <div id="filePicker">
                                <label class="trigger">+</label>
                                <input type="file" name="file" class="webuploader-element-invisible" accept="image/*">
                            </div>
                        </div>
                        <div class="progress-box">
                            <div class="progress">
                                <span class="text">0%</span>
                                <span class="percentage"></span>
                            </div><div class="info"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--图片上传-->

</div>

    <!-- 预览弹窗的框 -->
    <div class="popup popup-preview" style="display:none">
        <div class="content-block">
            <p><a href="#" class="close-popup">关闭</a></p>
            <div class="details">
                <div class="item-box">
                    <div class="zc-img"><img src="" id="previewImage"></div>
                    <div class="zc-text">
                        <div class="zc-name"><em class="tag">预览中</em> <div id="previewProjectName"></div></div>
                        <div class="zc-info">
                            <span class="time"><i class="i-time"></i>上课时间:<div id="previewCurriculumStartTime"></div></span>
                            <span class="address"><i class="i-address"></i><div id="previewSponsorCity"></div></span>
                        </div>
                        <div class="dashed-line"></div>
                        <div class="zc-info">
                            <span class="price">众筹最低学费:<span id="previewPrice"></span>元</span>
                            <span class="num">学员人数:0/<span id="previewMaxPeoples"></span>人</span>
                        </div>
                        <div class="row cb">
                            <div class="col-50" id="priviewCostTotalDIV">课程总成本:<span id="priviewCostTotal"></span></div>
                            <div class="col-50">目前人均价:<span id="priviewAATotal"></span></div>
                        </div>
                        <div class="zc-progress">
                            <div class="progress"><div class="progress-bar" style="width:1%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-block details-content">
                <p id="previewDetail"></p>
            </div>
        </div>
    </div>
<script type='text/javascript' src='${request.contextPath}/js/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='${request.contextPath}/js/upload.js?v=20160720-2' charset='utf-8'></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm.min.js"></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/picker.js"></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm-extend.min.js"></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm-city-picker.js"></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/my-js.js"></script>
<script type="text/javascript" src="${request.contextPath}/js/crowdFunding/config.js"></script>
</body>
<script type="application/javascript">
    $(function() {
        var today = new Date();

        var getDays = function(max) {
            var days = [];
            for(var i=1; i<= (max||31);i++) {
                days.push(i < 10 ? "0"+i : i);
            }
            return days;
        };

        var getDaysByMonthAndYear = function(month, year) {
            var int_d = new Date(year, parseInt(month)+1-1, 1);
            var d = new Date(int_d - 1);
            return getDays(d.getDate());
        };

        var formatNumber = function (n) {
            return n < 10 ? "0" + n : n;
        };

        var initMonthes = ('01 02 03 04 05 06 07 08 09 10 11 12').split(' ');

        var initYears = (function () {
            var arr = [];
            for (var i = 1950; i <= 2099; i++) { arr.push(i); }
            return arr;
        })();



        var date = new Date();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        var strDate2 = date.getDate()+1;
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        if (strDate2 >= 0 && strDate2 <= 9) {
            strDate2 = "0" + strDate2;
        }

        var startDateDB="${crowdFunding.curriculumStartTime}";
        $("#startTime").datetimePicker({
           value: [startDateDB.substring(0,4), startDateDB.substring(5,7), startDateDB.substring(8,10), startDateDB.substring(11,12)==0?startDateDB.substring(12,13):startDateDB.substring(11,13)],
            cols: [
                // Years
                {
                    values: initYears
                },
                // Months
                {
                    values: initMonthes
                },
                // Days
                {
                    values: getDays()
                },

                // Space divider
                {
                    divider: true,
                    content: '  '
                },
                // Hours
                {
                    values: (function () {
                        var arr = [];
                        for (var i = 0; i <= 23; i++) { arr.push(i); }
                        return arr;
                    })(),
                }
            ],
            formatValue: function (p, values, displayValues) {
                return displayValues[0] + '-' + values[1] + '-' + values[2] + ' ' + values[3];
            }
        });
        var endDateDB="${crowdFunding.curriculumEndTime}";
        $("#endTime").datetimePicker({
            value: [endDateDB.substring(0,4), endDateDB.substring(5,7), endDateDB.substring(8,10), endDateDB.substring(11,12)==0?endDateDB.substring(12,13):endDateDB.substring(11,13)],
            cols: [
                // Years
                {
                    values: initYears
                },
                // Months
                {
                    values: initMonthes
                },
                // Days
                {
                    values: getDays()
                },

                // Space divider
                {
                    divider: true,
                    content: '  '
                },
                // Hours
                {
                    values: (function () {
                        var arr = [];
                        for (var i = 0; i <= 23; i++) { arr.push(i); }
                        return arr;
                    })(),
                }
            ],
            formatValue: function (p, values, displayValues) {
                return displayValues[0] + '-' + values[1] + '-' + values[2] + ' ' + values[3];
            }
        });


        $(document).on("pageInit", function() {
            //初始化主办地址
            $("#address").cityPicker({
                toolbarTemplate: '<header class="bar bar-nav"><button class="button button-link pull-right close-picker">确定</button><h1 class="title">选择主办地址</h1></header>'
            });

            //费用均摊单击事件
            $("#costBetween").click(function() {
                $("#costSpan").text("总费用");
                $("#costTotal").attr("placeholder","总费用");

            });
            //一口价单击事件
            $("#price").click(function() {
                $("#costSpan").text("单价");
                $("#costTotal").attr("placeholder","单价");
            });



        });


        //添加图片显示
        $("#editImgFinish").click(function() {
            var imageUrl=$('#imageUrl')[0].src;
            if(imageUrl!=null && imageUrl!='' && imageUrl!='null' && imageUrl.lastIndexOf(".jpg")!=-1){
                $("#crowdFundingImageUrl").attr("src",imageUrl);
                $("#crowdFundingImageUrl").css("display","block");
            }

        });
        // 默认必须要执行$.init()
        $.init();

    });
    function preview(){
        var imageUrl = $('#imageUrl')[0].src;
        if(imageUrl.lastIndexOf(".jpg")==-1){
            imageUrl=$("#crowdFundingImageUrl").attr("src")
        }

        $("#previewImage").attr("src",imageUrl);
        $("#previewProjectName").text($("#projectName").val());

        $("#previewCurriculumStartTime").text($("#startTime").val());
        $("#previewSponsorCity").text($("#address").val());


        //最低学费
        //一口价
        if($("#price").attr("checked")){
            if($("#costTotal").val()!=null){
                $("#previewPrice").text($("#costTotal").val());
            }
        }
        else{
            //费用分摊 默认显示最低价 即除以最大人数
            if($("#costTotal").val()!=null && $("#maxPeoples").val()!=null){
                $("#previewPrice").text($("#costTotal").val()/$("#maxPeoples").val());
            }
        }
        $("#previewMaxPeoples").text($("#maxPeoples").val());

        if($("#costBetween").attr("checked")){
            $("#priviewCostTotal").text($("#costTotal").val());
        }
        else{
            $("#priviewCostTotalDIV").html("");
        }

        $("#priviewAATotal").text($("#costTotal").val());
        $("#previewDetail").text($("#detail").val());
    }
    //让每次都可以选择图片
    function updateType(type) {
        $("#imageId").val("");
        $("#imageUrl").attr("src", "");
        $("#imageUrl").css("display", "none");
        $('#filePicker').show();
    }
    function isEmpty(name){
        if($("#"+name).val()=='' || $("#"+name).val()==null || $("#"+name).val()=='null'){
            return true;
        }
        else{
            return false;
        }
    }
    //发布
    function publishCrowdFundingClick(){
        if(isEmpty("projectName")){
            $.toast("项目名称不能为空");
            return ;
        }
        if(isEmpty("startTime")){
            $.toast("课程开始时间不能为空");
            return ;
        }
        if(isEmpty("endTime")){
            $.toast("课程结束时间不能为空");
            return ;
        }
        if(isEmpty("address")){
            $.toast("主办地址不能为空");
            return ;
        }
        if(isEmpty("costTotal")){
            $.toast("总费用不能为空");
            return ;
        }
        if(isEmpty("minPeoples")){
            $.toast("最少人数不能为空");
            return ;
        }
        if(isEmpty("maxPeoples")){
            $.toast("最多人数不能为空");
            return ;
        }
        if(isEmpty("reservationCost")){
            $.toast("预约费用不能为空");
            return ;
        }


        var imageUrl = $('#imageUrl')[0].src;
        if(imageUrl.lastIndexOf(".jpg")>=0){
            $("#imgUrl").val(imageUrl);
        }
        else{
            $("#imgUrl").val($("#crowdFundingImageUrl").attr("src"));
        }
        $("#crowdfundingStatus").val("RELEASED");
        $.post('${request.contextPath}/crowdFunding/edit', $("#editCrowdFunding").serialize(), function (result) {
            if (result == "success") {
                $.toast("发布成功");
                window.location.href = "${request.contextPath}/crowdFunding/toMyCrowdFunding";
            }
            else if(result == "PROJECT_NAME_IS_EXISTING"){
                $.toast("项目名称已存在，请重新输入");
            }
            else if(result == "PROJECT_NAME_IS_NULL"){
                $.toast("项目名称不能为空，请重新输入");
            }
            else{
                $.toast("发布失败");
            }
        });
    }
    //保存草稿
    function sketchCrowdFundingClick(){
        if(isEmpty("projectName")){
            $.toast("项目名称不能为空");
            return ;
        }
        if(isEmpty("startTime")){
            $.toast("课程开始时间不能为空");
            return ;
        }
        if(isEmpty("endTime")){
            $.toast("课程结束时间不能为空");
            return ;
        }
        if(isEmpty("address")){
            $.toast("主办地址不能为空");
            return ;
        }
        if(isEmpty("costTotal")){
            $.toast("总费用不能为空");
            return ;
        }
        if(isEmpty("minPeoples")){
            $.toast("最少人数不能为空");
            return ;
        }
        if(isEmpty("maxPeoples")){
            $.toast("最多人数不能为空");
            return ;
        }
        if(isEmpty("reservationCost")){
            $.toast("预约费用不能为空");
            return ;
        }


        var imageUrl = $('#imageUrl')[0].src;
        if(imageUrl.lastIndexOf(".jpg")>=0){
            $("#imgUrl").val(imageUrl);
        }
        else{
            $("#imgUrl").val($("#crowdFundingImageUrl").attr("src"));
        }
        $("#crowdfundingStatus").val("SKETCH");
        $.post('${request.contextPath}/crowdFunding/edit', $("#editCrowdFunding").serialize(), function (result) {
            if (result == "success") {
                $.toast("草稿保存成功");
                window.location.href = "${request.contextPath}/crowdFunding/toMyCrowdFunding";
            }
            else if(result == "PROJECT_NAME_IS_EXISTING"){
                $.toast("项目名称已存在，请重新输入");
            }
            else if(result == "PROJECT_NAME_IS_NULL"){
                $.toast("项目名称不能为空，请重新输入");
            }
            else{
                $.toast("草稿保存失败");
            }
        });
    }
</script>
</html>