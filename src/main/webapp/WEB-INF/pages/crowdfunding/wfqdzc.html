<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>我发起的众筹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">      
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="众筹">
    <meta name="Keywords" content="众筹">
    <meta name="Description" content="众筹">
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/css/crowdFunding/sm.min.css">
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/css/crowdFunding/sm-extend.min.css">
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/css/crowdFunding/style.css">
    <script type="text/javascript" src="${request.contextPath}/js/zepto.min.js"></script>
    <script type="text/javascript" src="${request.contextPath}/js/crowdFunding/config.js"></script>
  </head>
  <body>
    <div class="page-group">
        <div class="page page-current">

        	<!--header start-->
            <header class="bar bar-nav">
                <a class="icon icon-left pull-left back" href="javascript:history.go(-1);"></a>
                <h1 class="title"></h1>
            </header>
            <!--header end-->
            <!--页面内容区域 start-->
            <div class="content infinite-scroll  wfqdzc-scroll"  data-distance="100">
                 <div class="list-block media-list wfqdzc-list">
                    <ul>
                    </ul>
                  </div>
                  
                  <!-- 加载提示符 -->
                  <div class="infinite-scroll-preloader">
                      <div class="preloader"></div>
                  </div>
                <div class="no-record" style="display: none;text-align: center">
                    没有更多记录了
                </div>
             </div>
            <!-- 页面内容区域 end -->
       </div>    
    </div>
    <script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm.min.js"></script>
    <script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm-extend.min.js"></script>
    <script type="text/javascript" src="${request.contextPath}/js/crowdFunding/sm-city-picker.min.js"></script>
    <script type="text/javascript" src="${request.contextPath}/js/crowdFunding/my-js.js"></script>
  </body>
  <script>

      // 我发起的众筹列表下拉无限加载
      var loading = false;
      // 最多可加载的条目
      var maxItems = 999;
      // 每次加载添加多少条目
      var itemsPerLoad = 20;
      function addItems(data) {
          // 生成新条目的HTML
          var html = '';
          var count=0;
          $.each(data, function(i, crowdFunding){
              count=i;

              var crowdfundingStatusName="已发布";
              if(crowdFunding.crowdfundingStatus=='SKETCH'){
                  crowdfundingStatusName='草稿';
              }
              else if(crowdFunding.crowdfundingStatus=='OFF_SHELVE'){
                  crowdfundingStatusName='已下架';
              }


              html += '<li><a href="#" class="item-link item-content create-actions" param="'+crowdFunding.crowdfundingId+'" param1="'+crowdFunding.crowdfundingStatus+'" rowNumber='+i+'>'+
                  '<div class="item-inner"><div class="item-title-row">'+
                  '<div class="item-title">'+crowdFunding.projectName+'</div></div>'+
                  '<div class="item-subtitle"><span class="tag" id="crowdfundingStatusName'+i+'">'+crowdfundingStatusName+'</span><span class="date">'+crowdFunding.curriculumEndTime+'</span></div>'+
                  '<div class="item-text"><span class="num">报名人数'+crowdFunding.enrollCount+'/'+crowdFunding.maxPeoples+'</span></div>'+
                  '</div></a></li>';
          });
          // 添加新条目
          $('.wfqdzc-scroll .wfqdzc-list ul').append(html);

          if(count+1 < itemsPerLoad){
              // 加载完毕，则注销无限加载事件，以防不必要的加载
              $.detachInfiniteScroll($('.infinite-scroll'));
              // 删除加载提示符
              $('.infinite-scroll-preloader').remove();
              $('.no-record').show();
          }
      }
      //预先加载众筹项目
      $.post('${request.contextPath}/crowdFunding/findCrowdFundingByOwner', {startIndex: 0,loadSize:itemsPerLoad}, function (response) {
          //预先加载众筹项目
          addItems(response);
      });



      // 上次加载的序号
      var lastIndex = itemsPerLoad;
      // 注册'infinite'事件处理函数
      $(document).on('infinite', '.wfqdzc-scroll',function() {
          // 如果正在加载，则退出
          if (loading) return;
          // 设置flag
          loading = true;
          // 模拟1s的加载过程
          setTimeout(function() {
              // 重置加载flag
              loading = false;
              if (lastIndex >= maxItems) {
                  // 加载完毕，则注销无限加载事件，以防不必要的加载
                  $.detachInfiniteScroll($('.infinite-scroll'));
                  // 删除加载提示符
                  $('.infinite-scroll-preloader').remove();
                  return;
              }

              // 添加新条目
              $.post('${request.contextPath}/crowdFunding/findCrowdFundingByOwner', {startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                  if(response==null || response==undefined ||  response==''){
                      // 加载完毕，则注销无限加载事件，以防不必要的加载
                      $.detachInfiniteScroll($('.infinite-scroll'));
                      // 删除加载提示符
                      $('.infinite-scroll-preloader').remove();
                      $('.no-record').show();
                      return;
                  }
                  else{
                      addItems(response);
                  }
              });

              // 更新最后加载的序号
              lastIndex = lastIndex+itemsPerLoad;
              //容器发生改变,如果是js滚动，需要刷新滚动
              $.refreshScroller();
          }, 1);
      });

      $(document).on("pageInit", ".page", function(e, id, page) {
          $(page).on('click','.create-actions', function () {
              var crowdfundingId=$(this).attr("param");
              var thiObj=$(this);
              var crowdfundingStatus=$(this).attr("param1");
              var showText="强制下架";
              if(crowdfundingStatus=='SKETCH' || crowdfundingStatus=='OFF_SHELVE'){
                  showText="发布";
              }
              var rowNumber=$(this).attr("rowNumber");
              var buttons1 = [
                  {
                      text: showText,
                      onClick: function() {
                          if(crowdfundingStatus=='SKETCH' || crowdfundingStatus=='OFF_SHELVE'){
                              $.post('${request.contextPath}/crowdFunding/updateSketchAndOffShelveToReleased', {crowdfundingId: crowdfundingId}, function (response) {
                                  if(response=='success'){
                                      $("#crowdfundingStatusName"+rowNumber).text("已发布");
                                      thiObj.attr("param1","RELEASED");
                                      $.toast("发布成功");
                                  }
                                  else{
                                      $.toast("发布失败");
                                  }
                              });
                          }
                          else{
                              $.prompt('请填写下架理由', '强制下架',
                                  function (value) {
                                      $.post('${request.contextPath}/crowdFunding/crowdFundingToShelve', {crowdfundingId: crowdfundingId,offShelveReason:value}, function (response) {
                                          if(response=='success'){
                                              $("#crowdfundingStatusName"+rowNumber).text("已下架");
                                              thiObj.attr("param1","OFF_SHELVE");
                                              $.toast("下架成功");
                                          }
                                          else{
                                              $.toast("下架失败");
                                          }
                                      });
                                  },
                                  function (value) {
                                      //$.alert('取消');
                                  }
                              );
                          }
                      }
                  },
                  {
                      text: '讨论管理',
                      onClick: function() {
                          window.location.href="${request.contextPath}/crowdFunding/toDetail?crowdFundingId="+crowdfundingId+"&commentFlag=true";

                      }
                  },
                  {
                      text: '报名名单',
                      onClick: function() {
                          window.location.href="${request.contextPath}/enroll/toCrowdfundingByMyEnrollToPaging?crowdFundingId="+crowdfundingId;
                      }
                  }
              ];
              var buttons2 = [
                  {
                      text: '取消',
                      bg: 'success'
                  }
              ];
              var groups = [buttons1, buttons2];
              $.actions(groups);
          });
      });
  </script>
</html>