<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>来接飚</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="stylesheet" href="${request.contextPath}/css/main.css">
    <link rel="stylesheet" href="${request.contextPath}/css/chat.css?t=201610291">
    <style>
        .chat-thread li.self:before {
            background-image: url(${otherUser.headImgPath});
        }
        .chat-thread li.other-side:before {
            background-image: url(${bidCreator.headImgPath});
        }
        .chat-thread{
            height: <#if bid.bidStatus == "finish" || audit == "audit">95%<#else>80%</#if>;
        }
    </style>
</head>
<body>
<input type="hidden" name="bidId" id="bidId" value="${bid.bidId}">
<input type="hidden" name="otherUserId" id="otherUserId" value="${otherUser.userId}">
<audio id="play_audio" volume="2"></audio>
<div class="page-group">
    <div class="page page-current">
        <!-- 你的html代码 -->
        <header class="bar bar-nav">

            <a class="icon icon-left pull-left back"></a>
            <h1 class='title'>来接飚</h1>

        </header>
        <div class="content">
            <ul class="chat-thread">
                <li class="other-side">${bid.content}</li>
                <!--<li>没多少，也就几个亿吧?</li>-->
                <!--<li>OK，我能搞定</li>-->
                <!--<li>Are we meeting today?</li>-->
                <!--<li>yes, what time suits you?</li>-->
                <!--<li>I was thinking after lunch, I have a meeting in the morning</li>-->
                <!--<li>Are we meeting today?</li>-->
                <!--<li>yes, what time suits you?</li>-->
                <!--<li>I was thinking after lunch, I have a meeting in the morning</li>-->
                <!--<li>Are we meeting today?</li>-->
                <!--<li>yes, what time suits you?</li>-->
                <!--<li>I was thinking after lunch, I have a meeting in the morning</li>-->
            </ul>
            <a id="speakBtn" style="display: none">
                <div class="speaker" >
                    <i id="speaker_phone" class="material-icons" style="font-size: 2rem;">speaker_phone</i>
                    <div id="speaker_phone_text" style="font-size: small">长按说话</div>
                </div>
            </a>
            <div class="popup-messages-footer" style="display: <#if bid.bidStatus == "finish" || audit == "audit">none<#else>block</#if>">
                <div class="message-input">
                    <textarea id="status_message" placeholder="请输入您要说的话..." rows="10" cols="40" name="message"></textarea>
                    <a href="#" class="button button-light" id="sendBidSubmitBtn">飙他</a>
                </div>
                <div class="btn-footer">
                    <button class="bg_none" id="voiceBtn"><i class="material-icons">settings_voice</i></button>
                    <button class="bg_none" id="imageBtn"><i class="material-icons">wallpaper</i></button>
                </div>
            </div>
        </div>
    </div>

</div>

<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script type='text/javascript' src='https://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
<script>
    var timeOutEvent=0;
    var webServerDomain = 'http://www.xiehoushike.com/bidsubmit';
    var currentUserId = '${currentUserId}';
    var bidCreatorUserId = '${bidCreator.userId}';
    var sendClassName;
    if(currentUserId == bidCreatorUserId){
        sendClassName = 'other-side';
    }else{
        sendClassName = 'self';
    }
    function longPress(){
        timeOutEvent = 0;
        $('#speakBtn').css({'-webkit-animation-name':'greenPulse','-webkit-animation-duration':'3s','-webkit-animation-iteration-count':'infinite'});
        $('#speaker_phone_text').text('正在录音，点击其他地方停止');
        wx.startRecord();
        wx.onVoiceRecordEnd({
            // 录音时间超过一分钟没有停止的时候会执行 complete 回调
            //这个函数不能算作监听，他一定要放在startRecord函数之后，否则不能执行，糟糕、愚蠢、误导人的设计
            complete: function (res) {
                var localId = res.localId;
                $('.chat-thread').append('<a class="play_voice" data="'+localId+'"><li class="'+sendClassName+'" ><i class="material-icons">hearing</i></li></a>');
                $('#speakBtn').hide();
                uploadVoice(localId);
            }
        });
    }
    function stopRecordVoiceFunc(){
        clearTimeout(timeOutEvent);
        $('#speakBtn').css({'-webkit-animation-name':'none','-webkit-animation-duration':'0','-webkit-animation-iteration-count':'infinite'});
        $('#speaker_phone_text').text('长按说话');
        wx.stopRecord({
            success: function (res) {
                var localId = res.localId;
                $('.chat-thread').append('<a class="play_voice" data="'+localId+'"><li class="'+sendClassName+'" ><i class="material-icons" >hearing</i></li></a>');
                $('#speakBtn').hide();
                uploadVoice(localId);
            }
        });
    }
    function uploadVoice(localId){
        wx.uploadVoice({
            localId: localId, // 需要上传的音频的本地ID，由stopRecord接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (res) {
                var serverId = res.serverId; // 返回音频的服务器端ID
                $.post('${request.contextPath}/bidsubmit/download-file', {bidId:$('#bidId').val(),serverId:serverId,otherUserId:$('#otherUserId').val(),fileType:'VOICE'}, function (response) {
                    $('.chat-thread').scrollTop($('.chat-thread').height() + 60);
                });
            }
        });
    }

$(function(){
    wx.config({
        appId: "${parmsMap['appId']}", // 必填，公众号的唯一标识
        timestamp:${parmsMap['timestamp']} , // 必填，生成签名的时间戳
        nonceStr: "${parmsMap['nonceStr']}", // 必填，生成签名的随机串
        signature: "${parmsMap['signature']}",// 必填，签名，见附录1
        jsApiList: [
            'checkJsApi',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'pauseVoice',
            'stopVoice',
            'onVoicePlayEnd',
            'uploadVoice',
            'hideOptionMenu'
        ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

    $.post('${request.contextPath}/bidsubmit/findsubmitlist', {bidId:$('#bidId').val(),otherUserId:$('#otherUserId').val()}, function (response) {
        var size = 0;
        var className = '';
        $.each(response, function(i, item){
            if(item.userId == bidCreatorUserId){
                className = 'other-side';
            }else{
                className = 'self';
            }
            if(item.bidSubmitType == 'TEXT'){
                $('.chat-thread').append('<li class="'+className+'">'+item.bidSubmitText+'</li>');
            }else if(item.bidSubmitType == 'IMAGE'){
                var imagePath = webServerDomain+"/"+item.bidId+"/"+item.wxServerId+".jpg";
                $('.chat-thread').append('<a class="play_img"><li class="'+className+'"><img style="height: 60px;width: 80px;" src="'+imagePath+'"/></li></a>');
            }else if(item.bidSubmitType == 'VOICE'){
                $('.chat-thread').append('<a class="play_voice" voice="'+item.wxServerId+'"><li class="'+className+'" ><i class="material-icons">hearing</i></li></a>');

            }
            size = i ++;

        });
        $('.chat-thread').scrollTop($('.chat-thread').height() + size*60);

    });
    $("body").on( "click", "#imageBtn", function(){
        wx.chooseImage({
            count: 1, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                $('.chat-thread').append('<li class="'+sendClassName+'"><img style="height: 60px;width: 80px;" src="'+localIds+'"/></li>');
//                $('.chat-thread').append('<li class="self" style="height: 90px;width: 120px;">' +
//                        '<img style="height: 60px;width: 80px;position:absolute;" src="'+localIds+'"/>' +
//                        '<div style="height: 60px;width: 80px;background-color: #00a1dc;position:absolute;z-index: 2;filter: alpha(opacity=70); opacity: 0.7;text-align: center;line-height: 60px;">0%</div>' +
//                        '</li>');

                wx.uploadImage({
                    localId: localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得
                    isShowProgressTips: 1, // 默认为1，显示进度提示
                    success: function (res) {
                        var serverId = res.serverId; // 返回图片的服务器端ID
                        $.post('${request.contextPath}/bidsubmit/download-file', {bidId:$('#bidId').val(),serverId:serverId,otherUserId:$('#otherUserId').val(),fileType:'IMAGE'}, function (response) {
                            $('.chat-thread').scrollTop($('.chat-thread').height() + 60);
                        });
                    }
                });

            }
        });

    } );
    $("body").on( "click", "#voiceBtn", function(){
        $('#speakBtn').show();
    });

    $("body").on( "touchstart", "#speakBtn", function(e){
        timeOutEvent = setTimeout("longPress()",500);
        e.preventDefault();
    });
    $("body").on( "touchmove", "#speakBtn", function(){
        clearTimeout(timeOutEvent);
        timeOutEvent = 0;
    });

    var playing = 0;

    var audio = document.getElementById('play_audio');
    audio.addEventListener('ended', function(){
        var audioId = $('#play_audio').attr('data');
        $("[voice='"+audioId+"']").find('i').css('color', '#212121');
        playing = 0;
    });
    $("body").on("click",".play_voice",function(){
        if($(this).attr("data")== null){
            var voicePath = webServerDomain+"/"+$('#bidId').val()+"/"+$(this).attr('voice')+".mp3";
            //var voicePath = $(this).attr('voice');
            if(playing == 0){
                $('#play_audio').attr("src",voicePath);
                $('#play_audio').attr("data",$(this).attr('voice'));
                $('#play_audio')[0].play();
                $(this).find('i').css('color', '#ff6701');
                playing = 1;
            }else{
                $('#play_audio')[0].pause();
                $(this).find('i').css('color', '#212121');
                playing = 0;
            }
        }else{
            var localId = $(this).attr('data');
            if(playing == 0){
                wx.playVoice({
                    localId: localId // 需要播放的音频的本地ID，由stopRecord接口获得
                });
                $(this).find('i').css('color', '#ff6701');
                playing = 1;
                wx.onVoicePlayEnd({//这个函数不能算作监听，他一定要放在playVoice函数之后，否则不能执行，糟糕、愚蠢、误导人的设计
                    success: function (res) {
                        var localId = res.localId; // 返回音频的本地ID
                        $("[data='"+localId+"']").find('i').css('color', '#212121');
                    }
                });

            }else{
                wx.stopVoice({
                    localId: localId // 需要停止的音频的本地ID，由stopRecord接口获得
                });
                $(this).find('i').css('color', '#212121');
                playing = 0;
            }
        }

    });
    $("body").on( "touchend", "#speakBtn", function(){
        stopRecordVoiceFunc();
        return false;
    });
    $("body").on( "click", function(e){
        if($(e.target).closest('#speakBtn').length <= 0 && $(e.target).closest('#voiceBtn').length <= 0){
            $('#speakBtn').hide();
            stopRecordVoiceFunc();
        }

    });

    $("body").on("click",".play_img",function(){
        var imgPath = $(this).find('img').attr('src');
        $('.photo-browser').remove();
        var myPhotoBrowserStandalone = $.photoBrowser({
            photos : [
                imgPath
            ],
            type: 'popup'
        });
        myPhotoBrowserStandalone.open();
    });
    $("body").on( "click", "#sendBidSubmitBtn", function(){
        var messageText = $('#status_message').val();
        if(messageText != ''){
            $('.chat-thread').append('<li class="'+sendClassName+'">'+messageText+'</li>');
            $('#status_message').val('');
            $.post('${request.contextPath}/bidsubmit/addtext', {bidId:$('#bidId').val(),otherUserId:$('#otherUserId').val(),text:messageText}, function (response) {

                if(response.messageType == 'success' ){

                    $('.chat-thread').scrollTop($('.chat-thread').height() + 40);
                }
            });
        }
    } );
})
    function onBridgeReady(){
        WeixinJSBridge.call('hideOptionMenu');
    }
    if (typeof WeixinJSBridge == "undefined"){
        if( document.addEventListener ){
            document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
        }else if (document.attachEvent){
            document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
            document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
        }
    }else{
        onBridgeReady();
    }
</script>
</body>
</html>