<div class="content-block card-container">
    </div>
    <!-- 默认的下拉刷新层 -->
    <div class="infinite-scroll-preloader">
        <div class="preloader"></div>
        <div class="no-record" style="display: none;text-align: center">
            没有更多记录了
        </div>
    </div>
<script>
    //banner图轮播
    if(typeof(window.swiperTimeout)=='undefined'){
        window.swiperTimeout=setTimeout(function () {
            var swiper = new Swiper('.swiper-container', {
                direction: 'horizontal',
                spaceBetween: 30,
                centeredSlides: true,
                autoplay: 2000,
                autoplayDisableOnInteraction: false,
                loop: true
            });
        }, 0);
    }
    $.showIndicator();
    var loading = false;
    // 最多可加载的条目
    var maxassemblys = 100;

    // 每次加载添加多少条目
    var assemblysPerLoad = 10;
    $("#searchType").val("${type}");
    function addassemblys(number, lastIndex,data) {
        // 生成新条目的HTML
        var html = '';
        var dataLength = 0;
        $.each(data, function(i, assembly){
            var type="线上活动";
            if(assembly.type=="online"){
                type="线上活动";

            }
            if(assembly.type=="face"){
                type="线下活动";
            }
            if(assembly.type=="train"){
                type="培训分享";
            }
            if(assembly.type=="company"){
                type="企业参考";
            }
            var titleImg="${request.contextPath}/images/assembly/default_tImage.jpg";
            if(assembly.titleImg!=""  && assembly.titleImg!=null && assembly.titleImg!="null"){
                titleImg=assembly.titleImg;
            }
            html +=' <div class="card" data-id="'+assembly.assemblyId+'">' +
                    ' <div class="userRow" >'+
                    ' <img class="userPhoto" src="'+assembly.userImg+'" align="left" style="border-radius:30px;margin-top: 0.2rem" />'+
                    ' <span class="userName" style="margin-top: 0.2rem;margin-left:0.5rem">'+assembly.userName+'</span>'+
                    '</div>'+
                    ' <div style="margin-top: 0.5rem">'+
                    ' <img src="'+titleImg+'" class="fullWidth" height="256px"  />'+
                    ' </div>'+
                    ' <h4 class="activityTitle">'+assembly.title+'</h4>'+
                    ' <div class="activityDesc">'+
                    ' <div class="startTime">'+assembly.startTime+' 开始</div>'+
                    '<div class="activityType">'+type+'</div>'+
                    ' <div class="activityPrice">'+
                    '￥<span class="priceNum">'+assembly.cost+'</span>起'+
                    '</div>'+
                    '</div>'+
                    '</div>';
            dataLength += 1;
        });
        if(dataLength == 0){
            $('.no-record').show();
            $('.infinite-scroll-preloader').remove();
        }else{
            $('.no-record').hide();
            // 添加新条目
            $('.infinite-scroll-bottom .card-container').append(html);
        }
        $.hideIndicator();

    }
    $.post('${request.contextPath}/assembly/list', {type:"${type}",searchName:"${searchName}",citySelect:"${citySelect}",startIndex: 0,loadSize:assemblysPerLoad}, function (response) {
        //预先加载20条
        addassemblys(assemblysPerLoad, 0,response);
    });


    // 上次加载的序号

    var lastIndex = 10;

    // 注册'infinite'事件处理函数
    $(document).on('infinite', '.infinite-scroll-bottom',function(e) {
        // 如果正在加载，则退出
        if (loading) return;
        // 设置flag
        loading = true;
        var type=$("#searchType").val();
        $.post('${request.contextPath}/assembly/list', {type:type,searchName:"${searchName}",citySelect:"${citySelect}",startIndex: lastIndex,loadSize:assemblysPerLoad}, function (response) {

            // 模拟1s的加载过程
            setTimeout(function() {
                // 重置加载flag
                loading = false;

                if (lastIndex >= maxassemblys) {
                    $.detachInfiniteScroll($('.infinite-scroll'));
                    // 删除加载提示符
                    $('.infinite-scroll-preloader').remove();
                    return;
                }

                // 添加新条目
                addassemblys(assemblysPerLoad, lastIndex,response);
                // 更新最后加载的序号
                lastIndex = $('.card-container .card').length;
                //容器发生改变,如果是js滚动，需要刷新滚动
                $.refreshScroller();
            }, 1000);
        });


    });
    $(function () {
        $(document).on("click",".card",function () {
            var assemblyId=$(this).attr("data-id");
           window.location.href="${request.contextPath}/assembly/to-detail?assemblyId="+assemblyId;
        });
    })
</script>
