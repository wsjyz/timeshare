<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>活动详情</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="http://g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="http://g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="stylesheet" href="${request.contextPath}/css/assembly/main.css">
  </head>
  <body>
  <div class="page-group">
      <div class="page">
          <div class="detailHeader header">
              <h1 class="title">邂逅活动</h1>
              <#if type=="MYASSEMBLY">
                  <a class="button button-link button-nav back pull-left" style="" external href="${request.contextPath}/assembly/myAssembly">
                      <span class="icon icon-left"></span>
                      返回
                  </a>

                  <#elseif type=="ASSEMBLYLIST">
                      <a class="button button-link button-nav back pull-left" style="" external href="${request.contextPath}/assembly/assemblyList">
                          <span class="icon icon-left"></span>
                          返回
                      </a>
                      <#elseif type=="COLLASSEMBLY">
                      <a class="button button-link button-nav back pull-left" style="" external href="${request.contextPath}/assembly/myCollectionAssembly">
                          <span class="icon icon-left"></span>
                          返回
                      </a>

                  <#else>
                      <a class="button button-link button-nav back pull-left" style="" external href="${request.contextPath}/assembly/to-index?type=${assembly.type}">
                          <span class="icon icon-left"></span>
                          返回
                      </a>
              </#if>

          </div>

          <nav class="bar bar-tab activityFooter">
              <a class="tab-item external item-message" href="#">
                  <span class="icon icon-message"></span>
                  <span class="tab-label">在线咨询</span>
              </a>

              <#if collectionStr=="false">
                  <a class="tab-item external" href="javaScript:void(0)" onclick="saveCollection()">
                      <span class="icon icon-star"></span>
                      <span class="tab-label">收藏(${collectionCount})</span>
                  </a>
              <#else>
                  <a class="tab-item external" disabled="disabled" href="javaScript:void(0)" >
                      <span class="icon icon-star"></span>
                      <span class="tab-label">已收藏(${collectionCount})</span>
                  </a>
              </#if>
              <a class="tab-item external item-me" href="#">
                  <span class="icon icon-me"></span>
                  <#if attenderTouser=="true">
                      <span>已报名</span>
                      <#else>
                          <span>我要报名</span>
                  </#if>
              </a>
          </nav>

          <div class="content activityContent">
              <div class="content-block">
                  <input type="hidden" name="feeId" value="">
                  <input type="hidden" name="price" value="">
                  <#if assembly.titleImg=="">
                      <img style="width:100%;height: calc(460/750*100vw)" src="${request.contextPath}/images/assembly/default_tImage.jpg"  />
                      <#else>
                      <img style="width:100%;height: calc(460/750*100vw)" src="${assembly.titleImg}"  />
                  </#if>
                  <h4 class="activityTitle">${assembly.title}</h4>
                  <div class="activityDesc">
                      <span>${assembly.createTime}</span>
                      <img class="eyeImg" src="${request.contextPath}/images/assembly/icon/eye.svg" />
                      <span class="viewNum">${assembly.browseTimes}</span>
                  </div>
                  <div class="activityRow">
                      <img class="clockImg" src="${request.contextPath}/images/assembly/icon/clock.png"/>
                      <span>${assembly.startTime} 至  ${assembly.endTime}</span>
                  </div>
                  <div class="activityRow">
                      <img src="${request.contextPath}/images/assembly/icon/type.png" />
                      <#if assembly.type=="online">
                          <span>线上活动</span>
                          <#elseif  assembly.type=="face">
                              <span>线下活动</span>
                      <#elseif assembly.type=="train">
                          <span>培训分享</span>
                      <#elseif assembly.type=="company">
                          <span>企业参访</span>
                      </#if>
                  </div>
                  <div class="activityRow">
                      <img src="${request.contextPath}/images/assembly/icon/human.png" />
                      <span>已报名${userCount}人</span>
                  </div>
                  <div class="activityRow">
                      <img src="${request.contextPath}/images/assembly/icon/type.png" />
                      <span>地址:${assembly.rendezvous!}</span>
                  </div>

                  <div class="activityRow">
                      <img class="moneyImg" src="${request.contextPath}/images/assembly/icon/money.png" />
                      <span class="money">${minMoney}-${maxMoney}</span>
                  </div>

                  <div class="userRow">
                      <img class="userPhoto" src="${assembly.userImg}" align="left" style="border-radius:35px"/>
                      <span class="userName">${assembly.userName}</span>
                      <span class="darkBg">主办方</span>
                  </div>

                  <div class="activityDetailWrap" style="height: 18.8rem;z-index:2;position:relative;overflow: hidden;">
                      <div class="activityDetail">
                          <div>${assembly.description}</div>
                      </div>
                  </div>
                  <div class="showMoreDetail">显示更多详情 <span class="icon icon-down"></span></div>
                  <section class="userSection">
                      <header>
                          <span class="pull-left">已报名(${userCount})</span>
                          <a class="pull-right" href="${request.contextPath}/assembly/showAttender?assemblyId=${assembly.assemblyId}">
                              更多报名
                              <span class="icon icon-right"></span>
                          </a>
                      </header>
                      <hr />
                      <ul class="userList">
                          <#list attenderList as attender>
                          <li>
                              <img src="${attender.userImg}" class="userPhoto" style="border-radius:35px"/>
                              <div>${attender.userName}</div>
                          </li>
                          </#list>
                      </ul>
                  </section>

                  <section class="commentSection" style="">
                      <header>
                          <span class="pull-left">点评(${commentList?size})</span>
                          <#if userInfo.acountType=="VIP">
                          <a class="pull-right external" href="${request.contextPath}/assembly/to-comment?assemblyId=${assembly.assemblyId}">
                              我要点评
                              <span class="icon icon-right"></span>
                          </a>
                          </#if>
                      </header>
                      <ul class="commentTagList">
                      </ul>
                      <hr />
                          <#list commentList as comment>
                              <header class="commentUser clearFix">
                              <img class="pull-left userPhoto" src="${comment.userImg}" style="border-radius:35px"/>
                              <div class="pull-left" style="padding-top: .3rem;">
                                  <span class="commentUserName">${comment.userName}</span>
                                  <span class="darkBg">${comment.acountType}</span> <br />
                                  打分
                                  <#if comment.rating gte 1>
                                      <span class="filledStar"></span>
                                      <#else>
                                          <span class="emptyStar"></span>
                                  </#if>
                                  <#if comment.rating gte 2>
                                      <span class="filledStar"></span>
                                      <#else>
                                          <span class="emptyStar"></span>
                                  </#if>
                                  <#if comment.rating gte 3>
                                      <span class="filledStar"></span>
                                      <#else>
                                          <span class="emptyStar"></span>
                                  </#if>
                                  <#if comment.rating gte 4>
                                      <span class="filledStar"></span>
                                      <#else>
                                          <span class="emptyStar"></span>
                                  </#if>
                                  <#if comment.rating gte 5>
                                      <span class="filledStar"></span>
                                      <#else>
                                          <span class="emptyStar"></span>
                                  </#if>
                              </div>
                              <span  class="pull-right">${comment.createTime}</span>
                          </header>
                          <div class="commentContent" style="">
                              ${comment.content}
                              <div class="commentImgs">
                                  <#list comment.commentImgList as commentImg>
                                      <img src="${commentImg}"  />
                                  </#list>
                              </div>
                          </div>
                          <footer class="commentFooter">
                              <span class="btnReply pull-right" data-id="${comment.commentId}">回复</span>
                              <#if comment.zanContent?contains(userInfo.nickName)>
                                  <span class="btnUpVote pull-right" data-id="${comment.commentId}"><span class="voteNum">${comment.zanSum}</span> 已赞</span>
                                  <#else>
                              <span class="btnUpVote pull-right" data-id="${comment.commentId}"><span class="voteNum">${comment.zanSum}</span> 赞</span>
                              </#if>
                          </footer>
                          <div class="replyArea">
                              <span class="replyTitle"></span>
                              <#list comment.replyContentList as replyContent>
                              <div class="replyContent">
                                      ${replyContent}
                              </div>
                              </#list>
                          </div>
                      </#list>
                  </section>
              </div>
              </div>
          </div>
      </div>
  </div>
    <script type='text/javascript' src='http://g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='http://g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='http://g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='${request.contextPath}/js/assembly/main.js' charset='utf-8'></script>
  <script type='text/javascript' src='https://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
  <script>
        wx.config({
            appId: "${parmsMap['appId']}", // 必填，公众号的唯一标识
            timestamp:${parmsMap['timestamp']} , // 必填，生成签名的时间戳
            nonceStr: "${parmsMap['nonceStr']}", // 必填，生成签名的随机串
            signature: "${parmsMap['signature']}",// 必填，签名，见附录1
            jsApiList: [
                'checkJsApi',
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'onMenuShareQQ'
            ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
        var shareImgUrl="";
       // <#if assembly.titleImg=="">
        shareImgUrl=="${request.contextPath}/images/assembly/default_tImage.jpg";
       //         <#else>
        shareImgUrl="${assembly.titleImg}";
            //    </#if>
        if(shareImgUrl.indexOf('http') == -1){
            shareImgUrl = 'http://jk.zhangqidong.cn'+shareImgUrl;
        }
        wx.ready(function(){
            wx.onMenuShareAppMessage({
                title: '邂逅活动',
                desc: $('.title').text(),
                link: window.location.href,
                imgUrl: shareImgUrl,
                trigger: function (res) {
                 //  alert('用户点击发送给朋友');
                },
                success: function (res) {
               //     $.toast('已分享');
                },
                cancel: function (res) {
              //      $.toast('已取消分享');
                },
                fail: function (res) {
              //      console.log('失败');
                }
            });
            wx.onMenuShareTimeline({
                title: $('.title').text(), // 分享标题
                link: window.location.href, // 分享链接
                imgUrl: shareImgUrl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

        });
        $(function(){

            //初始化"显示更多详情"按钮，1.初始时显示或隐藏本按钮, 2.绑定点击事件
            (function initMoreDetail(){
                var $detailWrap = $('.activityDetailWrap');
                var $showMoreDetail = $('.showMoreDetail');
                var detailHeight =$('.activityDetail').height();
                //显示或隐藏本按钮
                if(detailHeight>$detailWrap.height()){
                    $showMoreDetail.show();
                }else{
                    $showMoreDetail.hide();
                }

                //绑定点击事件
                $showMoreDetail.click(function(){
                    $detailWrap.css({overflow:'visible',height:'auto'})
                    $(this).hide();
                })
            }());

            $(document).on('click','.closeModal',function(){
                $.closeModal();
            });
            $(document).on('click','.btnUpVote',function(){
                var commentId=$(this).attr("data-id");
                $.post("${request.contextPath}/assembly/saveZan",{"commentId":commentId},function (data) {
                    if (data!="error"){
                        $('.voteNum').text(data)
                       // location='${request.contextPath}/assembly/to-detail?assemblyId=${assembly.assemblyId}';
                    }
                });
            });
            $(document).on('click', '.btnReply', function(){
                var commentId=$(this).attr("data-id");
                var $commentSection = $(this).parents('.commentSection');
                showReplyForm($commentSection,commentId);
            })
            $(document).on('click', '.item-message', function(e){
                e.preventDefault();
                $.modal({
                    extraClass:'vcodeModal',
                    title:  '<div class="buttons-row">'+
                    '   <h4 class="title">加好友咨询</h4>'+
                    '   <span class="closeModal"><img  src="${request.contextPath}/images/assembly/close.png" /></span>'+
                    '</div>',
                    text: ''+
                    '<div class="list-block"><ul>' +
                    '   <li>' +
                    '       <div >'+
                    '           <img src="${assembly.consultationImg}" style="width:100%;height: calc(460/750*100vw)" />'+
                    '       </div>'+
                    '   </li>' +
                    '</ul></div>',
                    buttons: []
                })
            });

            //回复
            function showReplyForm($commentSection,commentId){
                $.modal({
                    extraClass:'activityBottom activitySecondStep',
                    title:  '<div class="buttons-row">'+
                    '   <h4 class="title"></h4>'+
                    '   <span class="closeModal"><img src="${request.contextPath}/images/assembly/close.png" /></span>'+
                    '</div>',
                    text: ''+
                    '<div class="list-block"><ul>' +
                    '   <li>' +
                    '       <div class="item-content">'+
                    '           <textarea placeholder="填写回复" id="replyText"></textarea>'+
                    '       </div>'+
                    '   </li>' +
                    '</ul></div>',
                    buttons: [
                        {
                            text: '提交',
                            bold: true,
                            onClick:function(){
                                var replyText = $('#replyText').val();
                                $.post("${request.contextPath}/assembly/saveReply",{"commentId":commentId,"replyContent":replyText},function (data) {
                                    if (data!="error"){
                                        $commentSection.find('.replyArea').append("${userInfo.nickName}:"+replyText);
                                      // location='${request.contextPath}/assembly/to-detail?assemblyId=${assembly.assemblyId}';
                                    }
                                });
                            }
                        },
                    ]
                })
            }
            //显示报名表单第一页
            $(document).on('click', '.item-me', showEnrollForm);

            function showEnrollForm() {
                //<#if attenderTouser=="true">
                return false;
                //</#if>
                var text="";
                //<#list assembly.feeList as fee>
              //  <#if fee.quota==-1>
                text+= '<li>' +
                        '   <div class="item-content">'+
                        '       <div class="item-inner">' +
                        '           <i class="circle"></i>'+
                        '           <div class="item-title label">${fee.feeTitle}<br />' +
                        '           <span class="smallTitle">${fee.quotaTitle}</span>' +
                        '           </div>'+
                        '           <div class="item-input">'+
                        '               <label class="normalPrice">${fee.fee}</label>'+
                        '           </div>'+
                        '       </div>'+
                        '   </div>'+
                        '</li>' ;
                //<#else>
                    text+= '<li>' +
                            '   <div class="item-content">'+
                            '       <div class="item-inner">' +
                            '           <i class="circle"></i>'+
                            '           <div class="item-title label">${fee.feeTitle}<br />' +
                            '           <span class="smallTitle">${fee.quotaTitle}</span>' +
                            '           </div>'+
                            '           <div class="item-input">'+
                            '               <label class="normalPrice">${fee.fee}</label>'+
                            '               <label radioName="priceType" class="radioLabel" id="priceType${fee.feeId}" data-id="${fee.feeId}" data-price="${fee.fee}" /><input for="priceType${fee.feeId}" name="priceType" type="radio" value="${fee.feeId}">'+
                            '           </div>'+
                            '       </div>'+
                            '   </div>'+
                            '</li>' ;
                //</#if>
                //</#list>
                $.modal({
                    extraClass:'activityBottom activityFirstStep',
                    title:  '<div class="buttons-row">'+
                    '<h4 class="title">请在以下收费项目中选择</h4>'+
                    '<span class="closeModal"><img src="${request.contextPath}/images/assembly/close.png" /></span>'+
                    '</div>',
                    text: ''+
                    '  <div class="list-block"><ul>' +
                    text+'</ul></div>',
                    buttons: [
                        {
                            text: '下一步',
                            bold: true,
                            onClick:function(){
                                var feeId=$('label[radioname="priceType"].checked').attr('data-id');
                                if(feeId==undefined || feeId==""){
                                    $.alert("请选择一项报名费用!");
                                    return false;
                                }
                                var price=$('label[radioname="priceType"].checked').attr('data-price');
                                $("input[name='price']").val(price);
                                $("input[name='feeId']").val(feeId);
                                showNextStep();
                            }
                        },
                    ]
                })
            }
            //报名表单下一页
            function showNextStep(){
                var text="";
                //  <#if assembly.showApplyProblem?contains("userName")>
                text+= '   <li>' +
                        '       <div class="item-content">'+
                        '           <div class="item-media"><i class="icon icon-form-name"></i></div>'+
                        '           <div class="item-inner">'+
                        '              <div class="item-title label">姓名</div>'+
                        '               <div class="item-input">'+
                        '                   <input type="text" placeholder="" name="userName">'+
                        '               </div>'+
                        '           </div>'+
                        '       </div>'+
                        '   </li>' ;
                //</#if>
                //  <#if assembly.showApplyProblem?contains("phone")>
                text+= '   <li>' +
                        '       <div class="item-content">'+
                        '           <div class="item-media"><i class="icon icon-form-name"></i></div>'+
                        '           <div class="item-inner">'+
                        '              <div class="item-title label">手机</div>'+
                        '               <div class="item-input">'+
                        '                   <input type="text" placeholder="" name="phone">'+
                        '               </div>'+
                        '           </div>'+
                        '       </div>'+
                        '   </li>' ;
                //</#if>

                //  <#if assembly.showApplyProblem?contains("wx")>
                text+= '   <li>' +
                        '       <div class="item-content">'+
                        '           <div class="item-media"><i class="icon icon-form-name"></i></div>'+
                        '           <div class="item-inner">'+
                        '              <div class="item-title label">微信号</div>'+
                        '               <div class="item-input">'+
                        '                   <input type="text" placeholder="" name="wxName">'+
                        '               </div>'+
                        '           </div>'+
                        '       </div>'+
                        '   </li>' ;
                //</#if>
                //  <#if assembly.showApplyProblem?contains("email")>
                text+= '   <li>' +
                        '       <div class="item-content">'+
                        '           <div class="item-media"><i class="icon icon-form-name"></i></div>'+
                        '           <div class="item-inner">'+
                        '              <div class="item-title label">邮箱</div>'+
                        '               <div class="item-input">'+
                        '                   <input type="text" placeholder="" name="email">'+
                        '               </div>'+
                        '           </div>'+
                        '       </div>'+
                        '   </li>' ;
                //</#if>
                //  <#if assembly.showApplyProblem?contains("company")>
                text+= '   <li>' +
                        '       <div class="item-content">'+
                        '           <div class="item-media"><i class="icon icon-form-name"></i></div>'+
                        '           <div class="item-inner">'+
                        '              <div class="item-title label">所在企业</div>'+
                        '               <div class="item-input">'+
                        '                   <input type="text" placeholder="" name="companyName">'+
                        '               </div>'+
                        '           </div>'+
                        '       </div>'+
                        '   </li>' ;
                //</#if>
                $.modal({
                    extraClass:'activityBottom activitySecondStep',
                    title:  '<div class="buttons-row">'+
                    '   <h4 class="title">请填写报名信息</h4>'+
                    '   <span class="closeModal"><img src="${request.contextPath}/images/assembly/close.png" /></span>'+
                    '</div>',
                    text: ''+
                    '<div class="list-block"><ul>' +
                    text+
                    '</ul></div>',
                    buttons: [
                        {
                            text: '报名',
                            bold: true,
                            onClick:function(){
                                var feeId=$("input[name='feeId']").val();
                                var price=$("input[name='price']").val();
                                var questionAnswer="";
                                //  <#if assembly.showApplyProblem?contains("userName")>
                                var userName=$("input[name='userName']").val();
                                if (userName==""){
                                    $.alert("姓名是必填项！");
                                    return false;
                                }
                                if(userName!="" && userName!=undefined){
                                    questionAnswer=questionAnswer+"^"+userName;
                                }
                                //</#if>
                                //  <#if assembly.showApplyProblem?contains("phone")>
                                var phone=$("input[name='phone']").val();
                                if (phone==""){
                                    $.alert("手机是必填项！");
                                    return false;
                                }
                                if(phone!="" && phone!=undefined){
                                    if(!(/^1[3|4|5|8][0-9]\d{4,8}$/.test(phone))){
                                        $.alert("手机号码格式不正确!");
                                        return false;
                                    }
                                    questionAnswer=questionAnswer+"^"+phone;
                                }
                                //</#if>
                                //  <#if assembly.showApplyProblem?contains("wx")>
                                var wxName=$("input[name='wxName']").val();
                                if (wxName==""){
                                    $.alert("微信是必填项！");
                                    return false;
                                }
                                if(wxName!=""){
                                    questionAnswer=questionAnswer+"^"+wxName;
                                }
                                //</#if>
                                //  <#if assembly.showApplyProblem?contains("email")>
                                var email=$("input[name='email']").val();
                                if (email==""){
                                    $.alert("邮件是必填项！");
                                    return false;
                                }
                                if(email!="" && email!=undefined){
                                    var regex = /^([0-9A-Za-z\-_\.]+)@([0-9a-z]+\.[a-z]{2,3}(\.[a-z]{2})?)$/g;
                                    if ( !regex.test(email) ){
                                        $.alert("邮箱格式不正确!");
                                        return false;
                                    }
                                    questionAnswer=questionAnswer+"^"+email;
                                }
                                //</#if>
                                //  <#if assembly.showApplyProblem?contains("company")>
                                var companyName=$("input[name='companyName']").val();
                                if (companyName==""){
                                    $.alert("所在企业是必填项！");
                                    return false;
                                }
                                if(companyName!="" && companyName!=undefined){
                                    questionAnswer=questionAnswer+"^"+companyName;
                                }
                                //</#if>
                           //     window.location.href = "${request.contextPath}/assembly/saveAttender?assemblyId=${assembly.assemblyId}&questionAnswer="+questionAnswer+"&feeId="+feeId;
                                    window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxcd8903dd6a9552eb" +
                                            "&redirect_uri=http%3A%2F%2Fjk.zhangqidong.cn%2Ftime%2Fassembly%2Fto-pay-for-confirm%2F&response_type=code&scope=snsapi_base&state=" +feeId+"_${assembly.assemblyId}_"+questionAnswer+"#wechat_redirect";
                            }
                        },
                    ]
                })
            }
        })
        function saveCollection() {
            $.post("${request.contextPath}/assembly/saveCollection?assemblyId=${assembly.assemblyId}",function (data) {
                if (data!="error") {
                    location = '${request.contextPath}/assembly/to-detail?assemblyId=${assembly.assemblyId}';
                }
            })
        }
        $.init();
  </script>
  </body>
</html>
